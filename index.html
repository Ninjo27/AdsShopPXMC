<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>AdsShop - Trang Bán Hàng Xu</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* Giữ nguyên phần CSS của bạn ở đây */
    /* ... (copy toàn bộ CSS bạn đã gửi) ... */
  </style>
</head>
<body>
<!-- (Giữ nguyên phần modal và các section như bản gốc của bạn) -->
<!-- ... HTML như bạn gửi ... -->
<script>
  // --------- Cấu hình Supabase ----------
  const supabaseUrl = 'YOUR_SUPABASE_URL';
  const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null;
  let isAdmin = false;

  // --------- Đăng ký -----------
  async function register() {
    const username = document.getElementById('reg-username').value.trim();
    const password = document.getElementById('reg-password').value;
    const msg = document.getElementById('register-msg');
    if (!username || !password) {
      msg.textContent = "Vui lòng nhập đầy đủ thông tin!";
      return;
    }
    // Kiểm tra trùng user
    let { data: exist } = await supabase.from('users').select('id').eq('username', username).maybeSingle();
    if (exist) {
      msg.textContent = "Tên đăng nhập đã tồn tại!";
      return;
    }
    // Thêm user mới (mặc định 0 xu)
    let { error } = await supabase.from('users').insert([{ username, password, balance: 0 }]);
    if (error) {
      msg.textContent = "Lỗi: " + error.message;
    } else {
      msg.textContent = "Đăng ký thành công! Bạn có thể đăng nhập.";
      setTimeout(showLogin, 1000);
    }
  }

  // --------- Đăng nhập ----------
  async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const msg = document.getElementById('login-msg');
    let { data: user } = await supabase.from('users').select('*').eq('username', username).eq('password', password).maybeSingle();
    if (!user) {
      msg.textContent = "Sai tên đăng nhập hoặc mật khẩu!";
      return;
    }
    currentUser = user;
    isAdmin = (username === "admin");
    sessionStorage.setItem('currentUser', JSON.stringify(user));
    sessionStorage.setItem('showRulesModal', '1');
    location.reload();
  }

  function logout() {
    currentUser = null;
    isAdmin = false;
    sessionStorage.removeItem('currentUser');
    location.reload();
  }

  // Đọc user hiện tại từ sessionStorage (giữ đăng nhập khi reload)
  function getCurrentUser() {
    if (currentUser) return currentUser;
    const userStr = sessionStorage.getItem('currentUser');
    if (userStr) {
      currentUser = JSON.parse(userStr);
      isAdmin = (currentUser.username === "admin");
      return currentUser;
    }
    return null;
  }

  // --------- Giao diện Form ----------
  function showLogin() {
    document.getElementById('register-section').style.display = 'none';
    document.getElementById('login-section').style.display = 'block';
  }
  function showRegister() {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('register-section').style.display = 'block';
  }

  // --------- Sản phẩm (lấy từ Supabase) ----------
  let products = [];
  async function fetchProducts() {
    let { data, error } = await supabase.from('products').select('*');
    if (!error) products = data;
  }

  async function renderProducts() {
    await fetchProducts();
    const list = document.getElementById('products-list');
    list.innerHTML = '';
    products.forEach(p => {
      let stockText = p.stock > 0
        ? `<span class="product-stock">Còn lại: ${p.stock}</span>`
        : `<span class="out-of-stock">Hết hàng</span>`;
      let btnDisabled = p.stock <= 0 ? 'disabled' : '';
      list.innerHTML += `
        <div class="product">
          <img src="${p.image}" alt="${p.name}">
          <div class="product-title">${p.name}</div>
          <div class="product-price">${p.price} Xu</div>
          ${stockText}
          <div style="font-size:13px; color:#666;margin-bottom:6px">${p.description}</div>
          <button class="add-cart-btn" onclick="addToCart(${p.id})" ${btnDisabled}>${p.stock > 0 ? 'Thêm vào giỏ' : 'Hết hàng'}</button>
        </div>
      `;
    });
  }

  // --------- Giỏ hàng (lưu tạm trên sessionStorage/người dùng) ----------
  function getCart() {
    if (!getCurrentUser()) return [];
    return JSON.parse(sessionStorage.getItem('cart_' + currentUser.username) || '[]');
  }
  function saveCart(cart) {
    if (!getCurrentUser()) return;
    sessionStorage.setItem('cart_' + currentUser.username, JSON.stringify(cart));
  }

  function addToCart(productId) {
    const prod = products.find(p => p.id === productId);
    if (!prod || prod.stock <= 0) {
      alert("Hết hàng!");
      return;
    }
    let cart = getCart();
    let item = cart.find(i => i.id === productId);
    let currentQty = item ? item.qty : 0;
    if (currentQty + 1 > prod.stock) {
      alert("Không thể thêm vượt quá số lượng còn lại trong kho!");
      return;
    }
    if (item) item.qty++;
    else cart.push({ id: productId, qty: 1 });
    saveCart(cart);
    renderCart();
  }

  function removeCartItem(index) {
    let cart = getCart();
    cart.splice(index, 1);
    saveCart(cart);
    renderCart();
  }

  function changeQty(index, qty) {
    let cart = getCart();
    let pid = cart[index].id;
    let prod = products.find(p => p.id === pid);
    qty = Math.max(1, parseInt(qty));
    if (qty > prod.stock) {
      alert("Vượt quá số lượng còn lại trong kho!");
      qty = prod.stock;
    }
    cart[index].qty = qty;
    saveCart(cart);
    renderCart();
  }

  // --------- Hiển thị Giỏ hàng ----------
  function renderCart() {
    const tbody = document.querySelector('#cart-table tbody');
    const totalSpan = document.getElementById('cart-total');
    tbody.innerHTML = '';
    let cart = getCart();
    let total = 0;
    cart.forEach((item, idx) => {
      const prod = products.find(p => p.id === item.id);
      if (!prod) return;
      if (item.qty > prod.stock) {
        item.qty = prod.stock;
        saveCart(cart);
      }
      const line = prod.price * item.qty;
      total += line;
      tbody.innerHTML += `
        <tr>
          <td>${prod.name}</td>
          <td>${prod.price} Xu</td>
          <td>
            <input type="number" value="${item.qty}" min="1" max="${prod.stock}" style="width:50px" onchange="changeQty(${idx}, this.value)">
          </td>
          <td>${line} Xu</td>
          <td><button onclick="removeCartItem(${idx})">Xóa</button></td>
        </tr>
      `;
    });
    totalSpan.textContent = total;
    document.getElementById('checkout-btn').disabled = (cart.length === 0);
  }

  // --------- Thanh toán & Lưu đơn hàng Supabase ----------
  async function checkout() {
    const cart = getCart();
    if (cart.length === 0) return;
    let user = getCurrentUser();
    let { data: freshUser } = await supabase.from('users').select('*').eq('id', user.id).maybeSingle();
    let sum = 0;
    for (let item of cart) {
      let prod = products.find(p => p.id === item.id);
      if (!prod) continue;
      if (item.qty > prod.stock) {
        document.getElementById('cart-msg').textContent = `Sản phẩm "${prod.name}" chỉ còn lại ${prod.stock} cái!`;
        return;
      }
      sum += prod.price * item.qty;
    }
    if (freshUser.balance < sum) {
      document.getElementById('cart-msg').textContent = 'Không đủ Xu để thanh toán!';
      return;
    }
    // Trừ tồn kho, cập nhật xu
    for (let item of cart) {
      let prod = products.find(p => p.id === item.id);
      await supabase.from('products').update({ stock: prod.stock - item.qty }).eq('id', prod.id);
    }
    await supabase.from('users').update({ balance: freshUser.balance - sum }).eq('id', user.id);
    await supabase.from('orders').insert([{
      username: user.username,
      items: cart,
      total: sum,
      time: new Date().toLocaleString(),
      delivered: false
    }]);
    sessionStorage.removeItem('cart_' + user.username);
    document.getElementById('cart-msg').style.color = "#388e3c";
    document.getElementById('cart-msg').textContent = 'Thanh toán thành công! Cảm ơn bạn đã mua hàng.';
    setTimeout(()=>{document.getElementById('cart-msg').textContent='';document.getElementById('cart-msg').style.color='#d32f2f';},3000);
    await loadAll();
  }

  // --------- Hiển thị số dư và tên user ---------
  async function renderBalance() {
    const user = getCurrentUser();
    if (!user) return;
    let { data: freshUser } = await supabase.from('users').select('*').eq('id', user.id).maybeSingle();
    document.getElementById('username-display').textContent = user.username;
    document.getElementById('balance').textContent = freshUser ? freshUser.balance : user.balance;
  }

  // --------- ADMIN: Cấp xu, quản lý kho, đơn hàng ... (tương tự, chuyển local sang Supabase) ---------
  // Tương tự, bạn sẽ cần viết lại toàn bộ các hàm admin: renderAdminSection, addBalance, renderStockSection, updateStock, renderOrdersSection, markDelivered, v.v...  
  // Hãy dùng các truy vấn Supabase CRUD tương ứng (select, insert, update).

  // --------- Khởi động trang ---------
  async function loadAll() {
    if (!getCurrentUser()) {
      document.getElementById('shop-section').style.display = 'none';
      document.getElementById('user-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('admin-section').style.display = 'none';
      document.getElementById('stock-section').style.display = 'none';
      document.getElementById('orders-section').style.display = 'none';
      // ...renderSpecialLinkBtn();
      return;
    }
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('register-section').style.display = 'none';
    document.getElementById('shop-section').style.display = 'block';
    document.getElementById('user-section').style.display = 'block';
    await renderBalance();
    await renderProducts();
    renderCart();
    // ...renderAdminSection(); renderStockSection(); renderOrdersSection(); renderSpecialLinkBtn(); (tùy bạn thêm dần)
    // Modal thể lệ:
    if (sessionStorage.getItem('showRulesModal') === '1' && !sessionStorage.getItem('rulesModalSeen')) {
      showRulesModal();
      sessionStorage.removeItem('showRulesModal');
    }
    sessionStorage.removeItem('rulesModalSeen');
  }
  loadAll();

  function showRulesModal() {
    document.getElementById('rules-modal').style.display = 'block';
  }
  function hideRulesModal() {
    document.getElementById('rules-modal').style.display = 'none';
    sessionStorage.setItem('rulesModalSeen', '1');
  }
</script>
</body>
</html>
